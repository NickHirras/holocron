syntax = "proto3";

package holocron.v1;

import "google/protobuf/timestamp.proto";

option java_multiple_files = true;
option java_package = "holocron.v1";

// ============================================================================
// 1. TEMPLATE DEFINITIONS (The "Form Builder" side)
// ============================================================================

message CeremonyTemplate {
  string id = 1;
  string team_id = 2; // Which team owns this ceremony
  string title = 3;
  string description = 4;
  repeated Item items = 5;
  
  
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp updated_at = 7;
  
  string creator_id = 12; // Tracks the owner of the template for authorization

  // Form Settings
  bool collect_emails = 8;
  bool limit_one_response = 9;
  bool shuffle_question_order = 10;
  string confirmation_message = 11;
  
  // Phase 6
  bool is_public = 13;
  repeated string shared_with_emails = 14;

  // Phase 7: Notifications
  NotificationSettings notification_settings = 15;

  // Phase 8: Facilitation Mode
  FacilitationSettings facilitation_settings = 16;
}

message FacilitationSettings {
  bool is_anonymized = 1;
  bool responses_visible = 2; // If false, hide answer content until "Reveal"
  string active_item_id = 3;  // The specific question the team is currently discussing
}


message NotificationSettings {
  repeated string webhook_urls = 1;
  repeated string email_addresses = 2;
}

message Item {
  string item_id = 1; // Unique ID for drag-and-drop reordering & response tracking
  string title = 2;
  string description = 3;

  // Polymorphic item payload
  oneof kind {
    QuestionItem question_item = 4;
    QuestionGroupItem question_group_item = 5;
    PageBreakItem page_break_item = 6;
    TextItem text_item = 7;
    ImageItem image_item = 8;
    VideoItem video_item = 9;
  }
}

// -- Layout & Media Items --

message PageBreakItem {
  // Can be expanded later for conditional logic (e.g., "Go to section 2 based on answer")
  string next_section_id = 1;
}

message TextItem {
  // Just static text on the page, title/desc are handled by the parent Item
}

message ImageItem {
  string image_url = 1;
  string alt_text = 2;
}

message VideoItem {
  string video_url = 1;
  string caption = 2;
}

// -- Question Items --

message QuestionGroupItem {
  repeated Question questions = 1;
  // E.g., a grid of radio buttons where the columns are the same for multiple rows
}

message QuestionItem {
  Question question = 1;
}

message Question {
  string question_id = 1; // Used to map answers back to this specific question
  bool required = 2;

  oneof type {
    TextQuestion text_question = 3;
    ChoiceQuestion choice_question = 4;
    ScaleQuestion scale_question = 5;
    FileUploadQuestion file_upload_question = 6;
    DateQuestion date_question = 7;
    TimeQuestion time_question = 8;
  }
}

message TextQuestion {
  bool paragraph = 1; // If true, render a <textarea>. If false, <input type="text">
}

message ChoiceQuestion {
  enum Type {
    TYPE_UNSPECIFIED = 0; 
    TYPE_RADIO = 1;
    TYPE_CHECKBOX = 2;
    TYPE_DROP_DOWN = 3;
  }
  Type type = 1;
  repeated Option options = 2;
}

message Option {
  string value = 1;
  bool is_other = 2; // If true, frontend renders an "Other: [_____]" text input
  string next_section_id = 3; // For logic branching
}

message ScaleQuestion {
  int32 low = 1;
  int32 high = 2;
  string low_label = 3;  // e.g., "Not Confident"
  string high_label = 4; // e.g., "Very Confident"
}

message FileUploadQuestion {
  int32 max_files = 1;
  int64 max_file_size_bytes = 2;
  repeated string allowed_mime_types = 3; // e.g., "application/pdf", "image/png"
}

message DateQuestion {
  bool include_year = 1;
  bool include_time = 2;
}

message TimeQuestion {
  bool duration = 1;
}

// ============================================================================
// 2. RESPONSE DEFINITIONS (The "Submission" side)
// ============================================================================

message CeremonyResponse {
  string response_id = 1;
  string ceremony_template_id = 2;
  string user_id = 3; // The team member submitting
  
  google.protobuf.Timestamp submitted_at = 4;
  
  // A map is highly efficient here. 
  // Key = question_id, Value = The user's answer.
  map<string, Answer> answers = 5; 
}

message Answer {
  oneof kind {
    TextAnswer text_answer = 1;
    ChoiceAnswer choice_answer = 2;
    ScaleAnswer scale_answer = 3;
    FileUploadAnswer file_upload_answer = 4;
    DateAnswer date_answer = 5;
    TimeAnswer time_answer = 6;
  }
}

message TextAnswer {
  string value = 1;
}

message ChoiceAnswer {
  // Repeated to support CHECKBOX (multiple selections). 
  // RADIO/DROP_DOWN will just have one item here.
  repeated string values = 1; 
}

message ScaleAnswer {
  int32 value = 1;
}

message FileUploadAnswer {
  // URLs or storage bucket paths to the uploaded files
  repeated string file_uris = 1; 
}

message DateAnswer {
  int32 year = 1;
  int32 month = 2;
  int32 day = 3;
  int32 hours = 4;
  int32 minutes = 5;
}

message TimeAnswer {
  int32 hours = 1;
  int32 minutes = 2;
  int32 seconds = 3;
}

// ============================================================================
// 3. RPC SERVICES AND USER MESSAGES (The API Contract)
// ============================================================================

// -- Team Management --

message Team {
  string id = 1;
  string display_name = 2;
  google.protobuf.Timestamp created_at = 3;
}

message TeamMembership {
  string team_id = 1;
  string user_id = 2;
  Role role = 3;

  enum Role {
    ROLE_UNSPECIFIED = 0;
    ROLE_MEMBER = 1;
    ROLE_LEADER = 2;
  }
}

// -- User Management --

message User {
  string id = 1;
  string email = 2; // Derived from x-mock-user-id header
  
  google.protobuf.Timestamp created_at = 3;
  google.protobuf.Timestamp updated_at = 4;
  repeated string team_ids = 5;
}

service UserService {
  rpc GetSelf(GetSelfRequest) returns (GetSelfResponse);
}

message GetSelfRequest {
  // Empty, relies on headers
}

message GetSelfResponse {
  User user = 1;
}

// -- Team Service --

service TeamService {
  rpc CreateTeam(CreateTeamRequest) returns (CreateTeamResponse);
  rpc JoinTeam(JoinTeamRequest) returns (JoinTeamResponse);
  rpc ListMyTeams(ListMyTeamsRequest) returns (ListMyTeamsResponse);
}

message CreateTeamRequest {
  string display_name = 1;
}

message CreateTeamResponse {
  Team team = 1;
  TeamMembership membership = 2;
}

message JoinTeamRequest {
  string team_id = 1;
}

message JoinTeamResponse {
  TeamMembership membership = 1;
}

message ListMyTeamsRequest {
  // Empty, relies on headers
}

message ListMyTeamsResponse {
  repeated Team teams = 1;
  // include memberships so the frontend knows the role for each team
  repeated TeamMembership memberships = 2;
}

// -- Ceremony Service --

service CeremonyService {
  // Testing
  rpc Ping(PingRequest) returns (PingResponse);

  // Template Management
  rpc CreateCeremonyTemplate(CreateCeremonyTemplateRequest) returns (CreateCeremonyTemplateResponse);
  rpc UpdateCeremonyTemplate(UpdateCeremonyTemplateRequest) returns (UpdateCeremonyTemplateResponse);
  rpc GetCeremonyTemplate(GetCeremonyTemplateRequest) returns (GetCeremonyTemplateResponse);
  rpc ListCeremonyTemplates(ListCeremonyTemplatesRequest) returns (ListCeremonyTemplatesResponse);
  rpc ListActiveCeremonies(ListActiveCeremoniesRequest) returns (ListActiveCeremoniesResponse);

  // Response Management
  rpc SubmitCeremonyResponse(SubmitCeremonyResponseRequest) returns (SubmitCeremonyResponseResponse);
  rpc ListCeremonyResponses(ListCeremonyResponsesRequest) returns (ListCeremonyResponsesResponse);
}

// -- Service Messages --

message PingRequest {
  string message = 1;
}

message PingResponse {
  string message = 1;
}

message CreateCeremonyTemplateRequest {
  // The template to create. The ID will be generated by the server.
  CeremonyTemplate template = 1; 
}

message UpdateCeremonyTemplateRequest {
  CeremonyTemplate template = 1; 
}

message GetCeremonyTemplateRequest {
  string template_id = 1;
}

message ListCeremonyTemplatesRequest {
  string team_id = 1;
  // Standard Google API pagination
  int32 page_size = 2; 
  string page_token = 3;
}

message ListCeremonyTemplatesResponse {
  repeated CeremonyTemplate templates = 1;
  string next_page_token = 2;
}

message ListActiveCeremoniesRequest {
  string team_id = 1;
  int32 page_size = 2;
  string page_token = 3;
}

message ListActiveCeremoniesResponse {
  repeated ActiveCeremony active_ceremonies = 1;
  string next_page_token = 2;
}

message ActiveCeremony {
  CeremonyTemplate template = 1;
  ResponseStatus response_status = 2;
}

enum ResponseStatus {
  RESPONSE_STATUS_UNSPECIFIED = 0;
  RESPONSE_STATUS_PENDING = 1;
  RESPONSE_STATUS_COMPLETED = 2;
}

message SubmitCeremonyResponseRequest {
  CeremonyResponse response = 1;
}

message ListCeremonyResponsesRequest {
  string ceremony_template_id = 1;
  int32 page_size = 2;
  string page_token = 3;
  
  google.protobuf.Timestamp filter_start_date = 4;
  google.protobuf.Timestamp filter_end_date = 5;
}

message ListCeremonyResponsesResponse {
  repeated CeremonyResponse responses = 1;
  string next_page_token = 2;
}

message CreateCeremonyTemplateResponse {
  CeremonyTemplate template = 1; 
}

message UpdateCeremonyTemplateResponse {
  CeremonyTemplate template = 1; 
}

message GetCeremonyTemplateResponse {
  CeremonyTemplate template = 1;
}

message SubmitCeremonyResponseResponse {
  CeremonyResponse response = 1;
}

